// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ---- ENUMs ----
enum TipoUsuario {
  aluno
  professor
  administrador 
}

enum StatusSolicitacao {
  pendente
  aprovada
  rejeitada
}

enum UserStatus {
  ativo
  inativo
}

enum Instituicao {
  IFSUL_Gravatai 
  Outro
}

enum TipoNotificacao {
  nova_aula
  nova_atividade
  prazo_proximo
  prazo_atrasado
  nova_mensagem
  novo_curso
  geral
}

// ---- Modelos de Entidade ----

model Usuario {
  id            Int      @id @default(autoincrement())
  nome          String   @db.VarChar(100)
  email         String   @unique @db.VarChar(100)
  senha         String   @db.VarChar(255)
  foto_perfil   String?  @db.VarChar(255)
  instituicao   Instituicao @default(IFSUL_Gravatai)
  tipo          TipoUsuario 
  status        UserStatus @default(ativo) 
  data_cadastro DateTime @default(now())

  // Relacionamentos como Professor
  cursosCriados     Curso[]     @relation("ProfessorCursos")
  aulasCriadas      Aula[]      @relation("ProfessorAulas")
  atividadesCriadas Atividade[] @relation("ProfessorAtividades")

  // Relacionamentos como Aluno
  inscricoes    Inscricao[]
  notificacoes  Notificacao[]
  publicacoes   Publicacao[]
  comentarios   Comentario[]
}

model Solicitacao {
  id               Int      @id @default(autoincrement())
  nome             String   @db.VarChar(100)
  email            String   @unique @db.VarChar(100)
  senha_hash       String   @db.VarChar(255)
  foto_perfil      String?  @db.VarChar(255)
  instituicao      Instituicao @default(IFSUL_Gravatai)
  status           StatusSolicitacao @default(pendente)
  data_solicitacao DateTime @default(now())
}

model Curso {
  id          Int      @id @default(autoincrement())
  titulo      String   @db.VarChar(255)
  materia     String   @db.VarChar(100)
  descricao   String?  @db.Text 
  capa_curso  String   @db.VarChar(255)
  usuario_id  Int
  senha_acesso String? @db.VarChar(5) // ✅ NOVO: Senha opcional (máx 5 caracteres)

  professor   Usuario       @relation("ProfessorCursos", fields: [usuario_id], references: [id])
  inscricoes  Inscricao[]
  listas      Lista[]       // ✅ NOVO: Listas de conteúdo
  publicacoes Publicacao[]  // ✅ NOVO: Mural/Fórum

  @@index([usuario_id])
}

// ✅ NOVO: Sistema de Listas (para organizar aulas/atividades/materiais)
model Lista {
  id          Int      @id @default(autoincrement())
  titulo      String   @db.VarChar(255)
  descricao   String?  @db.Text
  ordem       Int
  curso_id    Int

  curso       Curso       @relation(fields: [curso_id], references: [id], onDelete: Cascade)
  aulas       Aula[]
  atividades  Atividade[]
  materiais   Material[]  // ✅ NOVO

  @@index([curso_id])
}

model Inscricao {
  id             Int      @id @default(autoincrement())
  usuario_id     Int
  curso_id       Int
  data_inscricao DateTime @default(now())

  aluno     Usuario     @relation(fields: [usuario_id], references: [id])
  curso     Curso       @relation(fields: [curso_id], references: [id], onDelete: Cascade)
  progresso Progresso[]

  @@unique([usuario_id, curso_id])
  @@index([curso_id])
}

model Aula {
  id          Int      @id @default(autoincrement())
  titulo      String   @db.VarChar(255)
  materia     String   @db.VarChar(100)
  descricao   String   @db.Text
  capa_aula   String   @db.VarChar(255)
  video       String   @db.VarChar(255)
  ordem       Int
  lista_id    Int?     // ✅ NOVO: Relacionamento com Lista
  usuario_id  Int
  prazo       DateTime? // ✅ NOVO: Prazo de conclusão

  lista       Lista?    @relation(fields: [lista_id], references: [id], onDelete: Cascade)
  professor   Usuario   @relation("ProfessorAulas", fields: [usuario_id], references: [id])
  progressos  Progresso[]

  @@index([lista_id])
  @@index([usuario_id])
}

model Atividade {
  id          Int      @id @default(autoincrement())
  titulo      String   @db.VarChar(255)
  materia     String   @db.VarChar(100)
  conteudo    Json
  ordem       Int
  lista_id    Int?     // ✅ NOVO: Relacionamento com Lista
  usuario_id  Int
  prazo       DateTime? // ✅ NOVO: Prazo de conclusão

  lista       Lista?    @relation(fields: [lista_id], references: [id], onDelete: Cascade)
  professor   Usuario   @relation("ProfessorAtividades", fields: [usuario_id], references: [id])
  progressos  Progresso[]

  @@index([lista_id])
  @@index([usuario_id])
}

// ✅ NOVO: Modelo de Material
model Material {
  id          Int      @id @default(autoincrement())
  titulo      String   @db.VarChar(255)
  descricao   String?  @db.Text
  tipo        String   @db.VarChar(50) // PDF, DOC, PPT, imagens, ZIP
  arquivo     String   @db.VarChar(255)
  ordem       Int
  lista_id    Int?
  data_upload DateTime @default(now())

  lista       Lista?   @relation(fields: [lista_id], references: [id], onDelete: Cascade)

  @@index([lista_id])
}

model Progresso {
  id               Int       @id @default(autoincrement())
  inscricao_id     Int
  aula_id          Int?
  atividade_id     Int?
  pontuacao_obtida Int?
  concluida        Boolean   @default(true)
  data_conclusao   DateTime  @default(now())

  inscricao Inscricao  @relation(fields: [inscricao_id], references: [id], onDelete: Cascade)
  aula      Aula?      @relation(fields: [aula_id], references: [id], onDelete: Cascade)
  atividade Atividade? @relation(fields: [atividade_id], references: [id], onDelete: Cascade)

  @@unique([inscricao_id, aula_id])
  @@unique([inscricao_id, atividade_id])
  @@index([aula_id])
  @@index([atividade_id])
}

// ✅ NOVO: Sistema de Fórum/Mural
model Publicacao {
  id           Int      @id @default(autoincrement())
  conteudo     String   @db.Text
  curso_id     Int
  usuario_id   Int
  data_criacao DateTime @default(now())
  editado      Boolean  @default(false)

  curso       Curso        @relation(fields: [curso_id], references: [id], onDelete: Cascade)
  autor       Usuario      @relation(fields: [usuario_id], references: [id])
  comentarios Comentario[]

  @@index([curso_id])
  @@index([usuario_id])
}

model Comentario {
  id            Int      @id @default(autoincrement())
  conteudo      String   @db.Text
  publicacao_id Int
  usuario_id    Int
  data_criacao  DateTime @default(now())
  editado       Boolean  @default(false)

  publicacao Publicacao @relation(fields: [publicacao_id], references: [id], onDelete: Cascade)
  autor      Usuario    @relation(fields: [usuario_id], references: [id])

  @@index([publicacao_id])
  @@index([usuario_id])
}

// ✅ NOVO: Sistema de Notificações
model Notificacao {
  id           Int              @id @default(autoincrement())
  tipo         TipoNotificacao
  titulo       String           @db.VarChar(255)
  mensagem     String           @db.Text
  link         String?          @db.VarChar(255)
  lida         Boolean          @default(false)
  usuario_id   Int
  data_criacao DateTime         @default(now())

  usuario Usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
  @@index([lida])
}