<!-- file: views/plataforma/admin_usuarios.ejs -->

<%- include('../partials/header_app') %>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Painel Administrativo</h1>
    <p class="text-sm text-gray-600 dark:text-gray-400">Gerencie usuários e solicitações do sistema</p>
</div>

<%- include('../partials/admin_nav', { activeTab: 'usuarios' }) %>

<div class="mt-8">
    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg overflow-hidden">
        
        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4"> 
                
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white whitespace-nowrap flex-shrink-0">
                    Lista de Usuários (<%= locals.totalUsers !== undefined ? totalUsers : 0 %>)
                </h2>
                
                <div class="w-full md:w-auto flex flex-col md:flex-row md:items-center gap-4"> 
                    
                    <% 
                        const filtroAtual = locals.filtroTipo || 'todos'; 
                        const baseClass = "px-3 py-1.5 md:px-4 md:py-2 text-xs md:text-sm font-medium rounded-lg border focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-150 ease-in-out whitespace-nowrap";
                        const activeClass = "bg-teal-600 dark:bg-teal-500 text-white border-transparent shadow";
                        const inactiveClass = "bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700";
                    %>
                    <div class="flex items-center space-x-2 flex-wrap gap-y-2 order-2 md:order-1"> 
                        <a href="/admin/usuarios" class="<%= baseClass %> <%= filtroAtual === 'todos' ? activeClass : inactiveClass %>">
                            Todos
                        </a>
                        <a href="/admin/usuarios?tipo=professor" class="<%= baseClass %> <%= filtroAtual === 'professor' ? activeClass : inactiveClass %>">
                            Professores
                        </a>
                        <a href="/admin/usuarios?tipo=aluno" class="<%= baseClass %> <%= filtroAtual === 'aluno' ? activeClass : inactiveClass %>">
                            Alunos
                        </a>
                         <a href="/admin/usuarios?tipo=administrador" class="<%= baseClass %> <%= filtroAtual === 'administrador' ? activeClass : inactiveClass %>">
                            Admin
                        </a>
                    </div>

                    <div class="relative w-full md:w-64 order-1 md:order-2"> 
                        <input type="text" placeholder="Buscar usuários..." 
                               class="border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 w-full pl-10 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500">
                        <i class="fa-solid fa-magnifying-glass h-5 w-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nome</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tipo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    <% if (typeof usuarios === 'undefined' || usuarios.length === 0) { %>
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Nenhum usuário encontrado para este filtro.</td>
                        </tr>
                    <% } else { %>
                        <% usuarios.forEach(usuario => { %>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-8 w-8 mr-3">
                                            <% if (usuario.foto_perfil) { %>
                                                <img class="h-8 w-8 rounded-full object-cover" src="/uploads/images/<%= usuario.foto_perfil %>" alt="Foto de <%= usuario.nome %>">
                                            <% } else { %>
                                                <span class="h-8 w-8 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 flex items-center justify-center font-semibold text-sm">
                                                    <%= usuario.nome ? usuario.nome.charAt(0).toUpperCase() : '?' %>
                                                </span>
                                            <% } %>
                                        </div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">
                                            <%= usuario.nome %>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                     <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                                        <%= usuario.tipo === 'administrador' ? 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200' : 
                                           (usuario.tipo === 'professor' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 
                                           'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200') %> 
                                        capitalize">
                                         
                                         <% if (usuario.tipo === 'administrador') { %>
                                            Admin
                                         <% } else { %>
                                            <%= usuario.tipo %>
                                         <% } %>
                                         
                                     </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <% if (usuario.status === 'ativo') { %>
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Ativo</span>
                                    <% } else { %>
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">Inativo</span>
                                    <% } %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400"><%= usuario.email %></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3">
                                    <a href="/admin/usuarios/<%= usuario.id %>/editar" title="Editar" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300">
                                        <i class="fa-solid fa-pen-to-square h-5 w-5"></i>
                                    </a>
                                    <% if (typeof locals.usuario !== 'undefined' && usuario.id !== locals.usuario.id) { %> 
                                        <form action="/admin/usuarios/<%= usuario.id %>/deletar" method="POST" class="inline" onsubmit="return confirm('Tem certeza que deseja deletar este usuário? Esta ação não pode ser desfeita.');">
                                            <button type="submit" title="Deletar" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                                                <i class="fa-solid fa-trash-can h-5 w-5"></i>
                                            </button>
                                        </form>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    <% } %>
                </tbody>
            </table>
        </div>

        <%# === SEÇÃO DE PAGINAÇÃO RESTAURADA === %>
        <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
            <div class="bg-white dark:bg-gray-800 px-4 py-3 flex items-center justify-between border-t border-gray-200 dark:border-gray-700 sm:px-6">
                
                <div class="flex-1 flex justify-between sm:hidden">
                    <% if (currentPage > 1) { %>
                        <a href="/admin/usuarios?page=<%= currentPage - 1 %>&tipo=<%= filtroAtual === 'todos' ? '' : filtroAtual %>" class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Anterior
                        </a>
                    <% } else { %>
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-400 dark:text-gray-500 bg-white dark:bg-gray-800 cursor-not-allowed">
                            Anterior
                        </span>
                    <% } %>
                    <% if (currentPage < totalPages) { %>
                        <a href="/admin/usuarios?page=<%= currentPage + 1 %>&tipo=<%= filtroAtual === 'todos' ? '' : filtroAtual %>" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Próximo
                        </a>
                     <% } else { %>
                         <span class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-400 dark:text-gray-500 bg-white dark:bg-gray-800 cursor-not-allowed">
                            Próximo
                         </span>
                    <% } %>
                </div>

                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                         <% if (typeof totalUsers !== 'undefined' && totalUsers > 0) { %>
                            <p class="text-sm text-gray-700 dark:text-gray-400">
                                Mostrando
                                <span class="font-medium"><%= (currentPage - 1) * 20 + 1 %></span>
                                a
                                <span class="font-medium"><%= Math.min(currentPage * 20, totalUsers) %></span>
                                de
                                <span class="font-medium"><%= totalUsers %></span>
                                resultados
                            </p>
                        <% } else { %>
                             <p class="text-sm text-gray-700 dark:text-gray-400">
                                0 resultados
                             </p>
                        <% } %>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <% if (currentPage > 1) { %>
                                <a href="/admin/usuarios?page=<%= currentPage - 1 %>&tipo=<%= filtroAtual === 'todos' ? '' : filtroAtual %>" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <span class="sr-only">Anterior</span>
                                    <i class="fa-solid fa-chevron-left h-5 w-5"></i>
                                </a>
                            <% } else { %>
                                 <span class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-400 dark:text-gray-500 cursor-not-allowed">
                                     <i class="fa-solid fa-chevron-left h-5 w-5"></i>
                                 </span>
                            <% } %>
                            
                            <% 
                            const maxPagesToShow = 5; 
                            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
                            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
                            if (totalPages > maxPagesToShow && endPage - startPage + 1 < maxPagesToShow) {
                                startPage = Math.max(1, endPage - maxPagesToShow + 1);
                            }
                            %>

                            <% if (startPage > 1) { %>
                                <a href="/admin/usuarios?page=1&tipo=<%= filtroAtual === 'todos' ? '' : filtroAtual %>" class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">1</a>
                                <% if (startPage > 2) { %> <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-700 dark:text-gray-300">...</span> <% } %>
                            <% } %>

                            <% for (let i = startPage; i <= endPage; i++) { %>
                                <a href="/admin/usuarios?page=<%= i %>&tipo=<%= filtroAtual === 'todos' ? '' : filtroAtual %>" 
                                   aria-current="<%= i === currentPage ? 'page' : undefined %>"
                                   class="relative inline-flex items-center px-4 py-2 border 
                                          <%= i === currentPage ? 'z-10 bg-teal-50 border-teal-500 text-teal-600 dark:bg-gray-700 dark:border-teal-400 dark:text-teal-300' : 'bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700' %> 
                                          text-sm font-medium">
                                    <%= i %>
                                </a>
                            <% } %>

                             <% if (endPage < totalPages) { %>
                                <% if (endPage < totalPages - 1) { %> <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-700 dark:text-gray-300">...</span> <% } %>
                                <a href="/admin/usuarios?page=<%= totalPages %>&tipo=<%= filtroAtual === 'todos' ? '' : filtroAtual %>" class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"><%= totalPages %></a>
                            <% } %>

                            <% if (currentPage < totalPages) { %>
                                <a href="/admin/usuarios?page=<%= currentPage + 1 %>&tipo=<%= filtroAtual === 'todos' ? '' : filtroAtual %>" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <span class="sr-only">Próximo</span>
                                     <i class="fa-solid fa-chevron-right h-5 w-5"></i>
                                </a>
                             <% } else { %>
                                 <span class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-400 dark:text-gray-500 cursor-not-allowed">
                                      <i class="fa-solid fa-chevron-right h-5 w-5"></i>
                                 </span>
                            <% } %>
                        </nav>
                    </div>
                </div>
            </div>
        <% } %>
        
    </div>
</div>

<%- include('../partials/footer_app') %>