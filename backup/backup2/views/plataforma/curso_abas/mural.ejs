<!-- file: views/plataforma/curso_abas/mural.ejs -->

<!-- Formulário de Nova Publicação -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
    <form id="formNovaPublicacao" class="space-y-4">
        <div>
            <label for="conteudo_publicacao" class="sr-only">Anuncie algo para a turma...</label>
            <textarea 
                id="conteudo_publicacao" 
                name="conteudo"
                rows="3"
                placeholder="Anuncie algo para a turma..."
                required
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-transparent resize-none"></textarea>
        </div>
        <div class="flex justify-end">
            <button 
                type="submit"
                class="flex items-center px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition duration-200">
                <i class="fas fa-paper-plane mr-2"></i>
                Postar
            </button>
        </div>
    </form>
</div>

<!-- Lista de Publicações -->
<div class="space-y-4">
    <% if (publicacoes.length === 0) { %>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-8 text-center">
            <i class="fas fa-comments text-5xl text-gray-300 dark:text-gray-600 mb-3"></i>
            <p class="text-gray-500 dark:text-gray-400">
                Nenhuma publicação ainda. Seja o primeiro a postar algo!
            </p>
        </div>
    <% } else { %>
        <% publicacoes.forEach(pub => { %>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <!-- Cabeçalho da Publicação -->
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center">
                        <% if (pub.autor.foto_perfil) { %>
                            <img class="h-10 w-10 rounded-full object-cover mr-3" 
                                 src="/uploads/images/<%= pub.autor.foto_perfil %>" 
                                 alt="<%= pub.autor.nome %>">
                        <% } else { %>
                            <span class="h-10 w-10 rounded-full bg-teal-100 dark:bg-teal-700 text-teal-700 dark:text-teal-100 flex items-center justify-center font-semibold mr-3">
                                <%= pub.autor.nome.charAt(0).toUpperCase() %>
                            </span>
                        <% } %>
                        <div>
                            <div class="flex items-center">
                                <p class="font-semibold text-gray-900 dark:text-white"><%= pub.autor.nome %></p>
                                <% if (pub.autor.tipo === 'professor' || pub.autor.tipo === 'administrador') { %>
                                    <span class="ml-2 px-2 py-0.5 bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300 text-xs font-medium rounded">
                                        <%= pub.autor.tipo === 'administrador' ? 'Admin' : 'Professor' %>
                                    </span>
                                <% } %>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                <%= new Date(pub.data_criacao).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) %>
                                <% if (pub.editado) { %> • <em>editado</em><% } %>
                            </p>
                        </div>
                    </div>
                    
                    <% if (usuario.id === pub.autor.id || eDono || eAdmin) { %>
                        <div class="relative">
                            <button onclick="togglePublicacaoMenu(<%= pub.id %>)" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                <i class="fas fa-ellipsis-vertical"></i>
                            </button>
                            <div id="menu-pub-<%= pub.id %>" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-lg shadow-lg py-1 z-10">
                                <button onclick="editarPublicacao(<%= pub.id %>)" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                                    <i class="fas fa-edit mr-2"></i>Editar
                                </button>
                                <button onclick="deletarPublicacao(<%= pub.id %>)" class="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600">
                                    <i class="fas fa-trash mr-2"></i>Deletar
                                </button>
                            </div>
                        </div>
                    <% } %>
                </div>

                <!-- Conteúdo da Publicação -->
                <div class="mb-4">
                    <p class="text-gray-800 dark:text-gray-200 whitespace-pre-wrap"><%= pub.conteudo %></p>
                </div>

                <!-- Seção de Comentários -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <button 
                        onclick="toggleComentarios(<%= pub.id %>)"
                        class="text-sm text-gray-600 dark:text-gray-400 hover:text-teal-600 dark:hover:text-teal-400 mb-3">
                        <i class="fas fa-comment mr-1"></i>
                        <%= pub.comentarios.length %> comentário<%= pub.comentarios.length !== 1 ? 's' : '' %>
                    </button>

                    <div id="comentarios-<%= pub.id %>" class="hidden space-y-3 mt-3">
                        <!-- Lista de Comentários -->
                        <% pub.comentarios.forEach(com => { %>
                            <div class="flex items-start space-x-3 pl-4 border-l-2 border-gray-200 dark:border-gray-700">
                                <% if (com.autor.foto_perfil) { %>
                                    <img class="h-8 w-8 rounded-full object-cover" 
                                         src="/uploads/images/<%= com.autor.foto_perfil %>" 
                                         alt="<%= com.autor.nome %>">
                                <% } else { %>
                                    <span class="h-8 w-8 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 flex items-center justify-center font-semibold text-xs">
                                        <%= com.autor.nome.charAt(0).toUpperCase() %>
                                    </span>
                                <% } %>
                                <div class="flex-1">
                                    <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-1">
                                            <p class="text-sm font-semibold text-gray-900 dark:text-white"><%= com.autor.nome %></p>
                                            <% if (usuario.id === com.autor.id || eDono || eAdmin) { %>
                                                <button onclick="deletarComentario(<%= com.id %>, <%= pub.id %>)" class="text-xs text-gray-400 hover:text-red-600">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            <% } %>
                                        </div>
                                        <p class="text-sm text-gray-800 dark:text-gray-200"><%= com.conteudo %></p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                            <%= new Date(com.data_criacao).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) %>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        <% }) %>

                        <!-- Formulário de Novo Comentário -->
                        <form onsubmit="comentarPublicacao(event, <%= pub.id %>)" class="flex items-start space-x-3 pl-4">
                            <% if (usuario.foto_perfil) { %>
                                <img class="h-8 w-8 rounded-full object-cover" 
                                     src="/uploads/images/<%= usuario.foto_perfil %>" 
                                     alt="<%= usuario.nome %>">
                            <% } else { %>
                                <span class="h-8 w-8 rounded-full bg-teal-100 dark:bg-teal-700 text-teal-700 dark:text-teal-100 flex items-center justify-center font-semibold text-xs">
                                    <%= usuario.nome.charAt(0).toUpperCase() %>
                                </span>
                            <% } %>
                            <div class="flex-1">
                                <input 
                                    type="text"
                                    name="conteudo"
                                    placeholder="Escreva um comentário..."
                                    required
                                    class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-teal-500">
                            </div>
                            <button type="submit" class="text-teal-600 hover:text-teal-700">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        <% }) %>
    <% } %>
</div>

<script>
// Publicar no mural
document.getElementById('formNovaPublicacao').addEventListener('submit', async (e) => {
    e.preventDefault();
    const conteudo = document.getElementById('conteudo_publicacao').value;
    
    try {
        const response = await fetch('/mural/<%= curso.id %>/publicacoes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ conteudo })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Erro ao publicar');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao publicar');
    }
});

function toggleComentarios(pubId) {
    const div = document.getElementById(`comentarios-${pubId}`);
    div.classList.toggle('hidden');
}

function togglePublicacaoMenu(pubId) {
    const menu = document.getElementById(`menu-pub-${pubId}`);
    menu.classList.toggle('hidden');
}

async function comentarPublicacao(event, pubId) {
    event.preventDefault();
    const form = event.target;
    const conteudo = form.conteudo.value;
    
    try {
        const response = await fetch(`/mural/publicacoes/${pubId}/comentarios`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ conteudo })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Erro ao comentar');
        }
    } catch (error) {
        console.error('Erro:', error);
    }
}

async function deletarPublicacao(pubId) {
    if (!confirm('Tem certeza que deseja deletar esta publicação?')) return;
    
    try {
        const response = await fetch(`/mural/publicacoes/${pubId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Erro ao deletar');
        }
    } catch (error) {
        console.error('Erro:', error);
    }
}

async function deletarComentario(comId, pubId) {
    if (!confirm('Tem certeza que deseja deletar este comentário?')) return;
    
    try {
        const response = await fetch(`/mural/comentarios/${comId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Erro ao deletar');
        }
    } catch (error) {
        console.error('Erro:', error);
    }
}
</script>