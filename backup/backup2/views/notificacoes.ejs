<!-- views/notificacoes.ejs -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= pageTitle %> | EduPlatform</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  
  <%- include('partials/navbar') %>

  <div class="max-w-4xl mx-auto px-4 py-8">
    
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">NotificaÃ§Ãµes</h1>
          <p class="text-gray-600 mt-1">
            <%= naoLidas > 0 ? `VocÃª tem ${naoLidas} notificaÃ§Ã£o${naoLidas > 1 ? 'Ãµes' : ''} nÃ£o lida${naoLidas > 1 ? 's' : ''}` : 'Nenhuma notificaÃ§Ã£o nova' %>
          </p>
        </div>
        
        <div class="flex gap-3">
          <% if (naoLidas > 0) { %>
          <button onclick="marcarTodasLidas()" 
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            Marcar todas como lidas
          </button>
          <% } %>
          
          <button onclick="limparLidas()" 
                  class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
            Limpar lidas
          </button>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
      <div class="flex gap-3 flex-wrap">
        <button onclick="filtrarNotificacoes('todas')" 
                class="filtro-btn px-4 py-2 rounded-lg bg-blue-600 text-white">
          Todas (<%= notificacoes.length %>)
        </button>
        <button onclick="filtrarNotificacoes('nao-lidas')" 
                class="filtro-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
          NÃ£o lidas (<%= naoLidas %>)
        </button>
        <button onclick="filtrarNotificacoes('curso')" 
                class="filtro-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
          Cursos
        </button>
        <button onclick="filtrarNotificacoes('mural')" 
                class="filtro-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
          Mural
        </button>
      </div>
    </div>

    <!-- Lista de NotificaÃ§Ãµes -->
    <div class="space-y-3" id="lista-notificacoes-completa">
      <% if (notificacoes.length === 0) { %>
        <div class="bg-white rounded-lg shadow-md p-12 text-center">
          <svg class="w-24 h-24 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
          </svg>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">Nenhuma notificaÃ§Ã£o</h3>
          <p class="text-gray-500">Quando houver novidades, elas aparecerÃ£o aqui.</p>
        </div>
      <% } else { %>
        <% notificacoes.forEach(notif => { %>
        <div class="notificacao-item bg-white rounded-lg shadow-md hover:shadow-lg transition <%= !notif.lida ? 'border-l-4 border-blue-500' : '' %>" 
             data-tipo="<%= notif.tipo %>" 
             data-lida="<%= notif.lida %>">
          <div class="p-5">
            <div class="flex items-start justify-between">
              
              <!-- ConteÃºdo -->
              <div class="flex-1 <%= notif.link ? 'cursor-pointer' : '' %>" 
                   onclick="<%= notif.link ? `abrirNotificacao(${notif.id}, '${notif.link}')` : '' %>">
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-2xl"><%= getIcone(notif.tipo) %></span>
                  <div>
                    <h3 class="font-semibold text-gray-900 text-lg"><%= notif.titulo %></h3>
                    <% if (notif.curso) { %>
                    <p class="text-sm text-blue-600">ðŸ“š <%= notif.curso.titulo %></p>
                    <% } %>
                  </div>
                  <% if (!notif.lida) { %>
                  <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                  <% } %>
                </div>
                
                <p class="text-gray-700 mb-3"><%= notif.mensagem %></p>
                
                <div class="flex items-center gap-4 text-sm text-gray-500">
                  <span>ðŸ•’ <%= formatarDataCompleta(notif.criado_em) %></span>
                  <span class="px-2 py-1 bg-gray-100 rounded text-xs">
                    <%= formatarTipo(notif.tipo) %>
                  </span>
                </div>
              </div>

              <!-- AÃ§Ãµes -->
              <div class="flex gap-2 ml-4">
                <% if (!notif.lida) { %>
                <button onclick="marcarLida(<%= notif.id %>)" 
                        class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition"
                        title="Marcar como lida">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </button>
                <% } %>
                
                <button onclick="deletarNotificacao(<%= notif.id %>)" 
                        class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition"
                        title="Deletar">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
        <% }) %>
      <% } %>
    </div>

  </div>

  <script>
    // Abrir notificaÃ§Ã£o com link
    async function abrirNotificacao(id, link) {
      try {
        await fetch(`/api/notificacoes/${id}/ler`, { method: 'PUT' });
        window.location.href = link;
      } catch (error) {
        console.error('Erro:', error);
      }
    }

    // Marcar como lida
    async function marcarLida(id) {
      try {
        const res = await fetch(`/api/notificacoes/${id}/ler`, { method: 'PUT' });
        if (res.ok) location.reload();
      } catch (error) {
        console.error('Erro:', error);
      }
    }

    // Marcar todas como lidas
    async function marcarTodasLidas() {
      try {
        const res = await fetch('/api/notificacoes/ler-todas', { method: 'PUT' });
        if (res.ok) location.reload();
      } catch (error) {
        console.error('Erro:', error);
      }
    }

    // Limpar lidas
    async function limparLidas() {
      if (!confirm('Deseja remover todas as notificaÃ§Ãµes lidas?')) return;
      
      try {
        const res = await fetch('/api/notificacoes/limpar-lidas', { method: 'DELETE' });
        if (res.ok) location.reload();
      } catch (error) {
        console.error('Erro:', error);
      }
    }

    // Deletar notificaÃ§Ã£o
    async function deletarNotificacao(id) {
      if (!confirm('Deseja deletar esta notificaÃ§Ã£o?')) return;
      
      try {
        const res = await fetch(`/api/notificacoes/${id}`, { method: 'DELETE' });
        if (res.ok) location.reload();
      } catch (error) {
        console.error('Erro:', error);
      }
    }

    // Filtrar notificaÃ§Ãµes
    function filtrarNotificacoes(filtro) {
      const notificacoes = document.querySelectorAll('.notificacao-item');
      const botoes = document.querySelectorAll('.filtro-btn');
      
      // Atualizar botÃµes ativos
      botoes.forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      event.target.classList.remove('bg-gray-200', 'text-gray-700');
      event.target.classList.add('bg-blue-600', 'text-white');
      
      // Filtrar
      notificacoes.forEach(notif => {
        const tipo = notif.dataset.tipo;
        const lida = notif.dataset.lida === 'true';
        
        let mostrar = false;
        
        if (filtro === 'todas') mostrar = true;
        else if (filtro === 'nao-lidas') mostrar = !lida;
        else mostrar = tipo === filtro;
        
        notif.style.display = mostrar ? 'block' : 'none';
      });
    }
  </script>

  <%
    function getIcone(tipo) {
      const icones = {
        'curso': 'ðŸ“š',
        'atividade': 'ðŸ“',
        'prazo': 'â°',
        'mural': 'ðŸ’¬',
        'sistema': 'â„¹ï¸',
        'sucesso': 'âœ…',
        'alerta': 'âš ï¸'
      };
      return icones[tipo] || 'â„¹ï¸';
    }

    function formatarTipo(tipo) {
      const tipos = {
        'curso': 'Curso',
        'atividade': 'Atividade',
        'prazo': 'Prazo',
        'mural': 'Mural',
        'sistema': 'Sistema',
        'sucesso': 'Sucesso',
        'alerta': 'Alerta'
      };
      return tipos[tipo] || tipo;
    }

    function formatarDataCompleta(data) {
      const d = new Date(data);
      return d.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
  %>

</body>
</html>